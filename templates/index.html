{% extends "base.html" %}

{% block title %}Dashboard - WhatsApp Bot{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Login Status Card -->
    <div class="login-status-card" id="loginStatusCard">
        <div class="status-content">
            <div class="status-icon" id="statusIcon">
                <i class="fas fa-circle-notch fa-spin"></i>
            </div>
            <div class="status-info">
                <h3 id="statusTitle">Checking Status...</h3>
                <p id="statusMessage">Please wait</p>
            </div>
            <div class="status-actions" id="statusActions">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>
        
        <!-- QR Code Display Area -->
        <div id="qrCodeContainer" style="display: none; text-align: center; margin-top: 20px; padding: 20px; background: #fff; border-radius: 10px;">
            <h3 style="color: #333; margin-bottom: 15px;">üì± Scan this QR Code with WhatsApp</h3>
            <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 300px; border: 5px solid #25D366; border-radius: 10px;">
            <p style="color: #666; margin-top: 15px; font-size: 14px;">
                Open WhatsApp on your phone ‚Üí Menu ‚Üí Linked Devices ‚Üí Link a Device
            </p>
            <button onclick="refreshQRCode()" class="btn btn-primary" style="margin-top: 10px;">
                <i class="fas fa-sync"></i> Refresh QR Code
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-envelope"></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.total_messages }}</h3>
                <p>Total Messages</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.sent_messages }}</h3>
                <p>Sent Successfully</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon red">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.failed_messages }}</h3>
                <p>Failed</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.total_contacts }}</h3>
                <p>Total Contacts</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.scheduled_messages }}</h3>
                <p>Scheduled Messages</p>
            </div>
        </div>
    </div>

    <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
            <a href="/bulk" class="action-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-paper-plane"></i>
                <span>Bulk Send</span>
            </a>
            <a href="/contacts" class="action-btn">
                <i class="fas fa-user-plus"></i>
                <span>Contacts</span>
            </a>
            <a href="/history" class="action-btn">
                <i class="fas fa-list"></i>
                <span>History</span>
            </a>
        </div>
    </div>

    <div class="info-section">
        <h2>Getting Started</h2>
        <div class="info-card">
            <ol>
                <li>Click "Initialize Bot" to start the WhatsApp Web session</li>
                <li>Scan the QR code with your WhatsApp mobile app</li>
                <li>Once logged in, go to <strong>Bulk Send</strong> to send messages</li>
                <li>Add phone numbers or import from CSV</li>
                <li>Attach files (auto-detects type) and send to all contacts</li>
            </ol>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="info-section">
        <h2><i class="fas fa-cog"></i> Settings</h2>
        <div class="info-card">
            <div class="settings-form">
                <div class="setting-item">
                    <label class="switch-label">
                        <span class="setting-name">
                            <i class="fas fa-eye-slash"></i> Headless Mode
                        </span>
                        <span class="setting-desc">Run browser in background (no visible window) <strong style="color: #e74c3c;">‚ö†Ô∏è Requires bot restart</strong></span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="headlessMode" onchange="updateSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <label class="switch-label" for="defaultCountryCode">
                        <span class="setting-name">
                            <i class="fas fa-globe"></i> Default Country Code
                        </span>
                        <span class="setting-desc">Auto-added when phone number doesn't have country code</span>
                    </label>
                    <div class="country-code-input">
                        <span class="plus-sign">+</span>
                        <input type="text" id="defaultCountryCode" placeholder="91" maxlength="4" onchange="updateSettings()">
                    </div>
                </div>
            </div>
            <div class="settings-note" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px;">
                <i class="fas fa-info-circle" style="color: #856404;"></i>
                <strong>Note:</strong> Headless mode changes take effect after restarting the bot. 
                Turn OFF headless to see the browser window (useful for QR scan).
            </div>
            <button onclick="restartBot()" class="btn btn-warning" style="margin-top: 15px; width: 100%;">
                <i class="fas fa-sync"></i> Restart Bot (Apply Settings)
            </button>
        </div>
    </div>
</div>

<style>
.settings-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}
.switch-label {
    display: flex;
    flex-direction: column;
}
.setting-name {
    font-weight: 600;
    color: #333;
}
.setting-desc {
    font-size: 12px;
    color: #666;
    margin-top: 3px;
}
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}
.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 26px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #25D366;
}
input:checked + .slider:before {
    transform: translateX(24px);
}
.country-code-input {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 5px 10px;
}
.country-code-input .plus-sign {
    color: #666;
    font-weight: 600;
    margin-right: 2px;
}
.country-code-input input {
    border: none;
    outline: none;
    width: 60px;
    font-size: 14px;
    font-weight: 500;
}
</style>

<script>
let qrCheckInterval = null;
let isInitializing = false;

// Check login status on page load
async function checkLoginStatus() {
    try {
        const response = await fetch('/api/check-login');
        const data = await response.json();
        
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const statusActions = document.getElementById('statusActions');
        const loginCard = document.getElementById('loginStatusCard');
        const qrContainer = document.getElementById('qrCodeContainer');
        
        if (data.logged_in) {
            // User is logged in
            loginCard.classList.add('status-success');
            loginCard.classList.remove('status-warning', 'status-error');
            statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            statusTitle.textContent = 'Connected to WhatsApp';
            statusMessage.textContent = 'You are successfully logged in and ready to send messages!';
            statusActions.innerHTML = '';
            qrContainer.style.display = 'none';
            
            // Stop QR code checking
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        } else if (data.status === 'waiting_for_scan') {
            // Bot initialized, waiting for QR scan
            loginCard.classList.add('status-warning');
            loginCard.classList.remove('status-success', 'status-error');
            statusIcon.innerHTML = '<i class="fas fa-qrcode"></i>';
            statusTitle.textContent = 'Scan QR Code';
            statusMessage.textContent = 'Scan the QR code below with your WhatsApp mobile app';
            statusActions.innerHTML = '';
            
            // Get QR code
            await fetchAndDisplayQR();
        } else {
            // Bot not initialized
            loginCard.classList.add('status-error');
            loginCard.classList.remove('status-success', 'status-warning');
            statusIcon.innerHTML = '<i class="fas fa-power-off"></i>';
            statusTitle.textContent = 'Not Connected';
            statusMessage.textContent = 'Click below to start the bot and get QR code';
            qrContainer.style.display = 'none';
            statusActions.innerHTML = `
                <button onclick="initializeBot()" class="btn btn-success" ${isInitializing ? 'disabled' : ''}>
                    <i class="fas fa-play"></i> ${isInitializing ? 'Initializing...' : 'Initialize Bot'}
                </button>
            `;
        }
    } catch (error) {
        console.error('Error checking login status:', error);
    }
}

async function fetchAndDisplayQR() {
    try {
        const response = await fetch('/api/get-qr-code');
        const data = await response.json();
        
        const qrContainer = document.getElementById('qrCodeContainer');
        const qrImage = document.getElementById('qrCodeImage');
        
        if (data.status === 'qr_ready' && data.qr) {
            // Add data URI prefix for base64 image
            qrImage.src = 'data:image/png;base64,' + data.qr;
            qrContainer.style.display = 'block';
        } else if (data.status === 'logged_in') {
            qrContainer.style.display = 'none';
            checkLoginStatus();
        } else if (data.status === 'loading' || data.status === 'waiting') {
            // Still loading, wait and retry
            qrContainer.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: #25D366;"></i>
                    <p style="margin-top: 15px; color: #666;">Loading QR code...</p>
                </div>
            `;
            qrContainer.style.display = 'block';
        }
    } catch (error) {
        console.error('Error fetching QR code:', error);
    }
}

async function refreshQRCode() {
    const qrImage = document.getElementById('qrCodeImage');
    qrImage.style.opacity = '0.5';
    
    await fetchAndDisplayQR();
    
    qrImage.style.opacity = '1';
}

async function initializeBot() {
    if (isInitializing) return;
    
    isInitializing = true;
    const statusActions = document.getElementById('statusActions');
    statusActions.innerHTML = `
        <button class="btn btn-success" disabled>
            <i class="fas fa-circle-notch fa-spin"></i> Initializing...
        </button>
    `;
    
    try {
        const response = await fetch('/api/initialize-bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Bot started! Loading QR code...', 'success');
            
            // Wait a moment for WhatsApp to load
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Start checking for QR code and login status
            await checkLoginStatus();
            
            // Start interval to check login status
            if (!qrCheckInterval) {
                qrCheckInterval = setInterval(async () => {
                    const loginResponse = await fetch('/api/check-login');
                    const loginData = await loginResponse.json();
                    
                    if (loginData.logged_in) {
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                        checkLoginStatus();
                        showAlert('Successfully connected to WhatsApp!', 'success');
                    } else {
                        // Refresh QR code periodically (QR codes expire)
                        await fetchAndDisplayQR();
                    }
                }, 5000);
            }
        } else {
            showAlert(data.error || 'Failed to initialize bot', 'error');
        }
    } catch (error) {
        showAlert('Failed to initialize bot: ' + error.message, 'error');
    } finally {
        isInitializing = false;
    }
}

// Check login status on page load
checkLoginStatus();
loadSettings();

// Load settings from server
async function loadSettings() {
    try {
        const response = await fetch('/api/settings');
        const data = await response.json();
        if (data.success) {
            document.getElementById('headlessMode').checked = data.settings.headless || false;
            document.getElementById('defaultCountryCode').value = data.settings.default_country_code || '91';
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Update settings on server
async function updateSettings() {
    const headless = document.getElementById('headlessMode').checked;
    const countryCode = document.getElementById('defaultCountryCode').value.trim().replace('+', '');
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ headless, default_country_code: countryCode })
        });
        const data = await response.json();
        if (data.success) {
            showAlert('Settings saved!', 'success');
        } else {
            showAlert('Failed to save settings', 'error');
        }
    } catch (error) {
        showAlert('Error saving settings: ' + error.message, 'error');
    }
}

// Restart bot to apply settings
async function restartBot() {
    if (!confirm('This will close the current browser and start a new one. Continue?')) {
        return;
    }
    
    showAlert('Restarting bot...', 'info');
    
    try {
        // First close the existing bot
        await fetch('/api/close-bot', { method: 'POST' });
        
        // Wait a moment
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Initialize new bot
        const response = await fetch('/api/initialize-bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`Bot restarted! Headless: ${data.headless ? 'ON' : 'OFF'}`, 'success');
            setTimeout(() => checkLoginStatus(), 3000);
        } else {
            showAlert('Failed to restart bot: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Error restarting bot: ' + error.message, 'error');
    }
}
</script>
{% endblock %}

